<canvas id="maze"></canvas>

<script>
    let maze = {
        dimensions: {
            x: 3,
            y: 3
        },
        labyrinth: [],
        sprites: [],
        shift: 0,
        draw: function() {
            for (let i = 0; i < maze.dimensions.x; i++)
                for (let j = 0; j < maze.dimensions.y; j++) {
                    ctx.drawImage(this.getSprite(this.labyrinth[j][i]), (i+1)*64, (j+1)*64, 64, 64);
                }
        },
        insert: function(insertion, number) {
            maze.draw();
            
            this.animate(insertion, number);
        },

        animate: function(insertion, number) {
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sliding and fixed images
            for (let i = 0; i < maze.dimensions.x; i++) {
                for (let j = 0; j < maze.dimensions.y; j++) {
                    if (insertion < 2) {
                        if(j === number) ctx.drawImage(this.getSprite(this.labyrinth[j][i]), maze.shift + (i+1)*64, (j+1)*64, 64, 64);
                        else ctx.drawImage(this.getSprite(this.labyrinth[j][i]), (i+1)*64, (j+1)*64, 64, 64);
                    } else if (insertion >= 2) {
                        if(i === number) ctx.drawImage(this.getSprite(this.labyrinth[j][i]), (i+1)*64, maze.shift + (j+1)*64, 64, 64);
                        else ctx.drawImage(this.getSprite(this.labyrinth[j][i]), (i+1)*64, (j+1)*64, 64, 64);
                    }
                }
            }

            // If the images have reached their final destination, end movement
            if ((insertion%2 === 1 && maze.shift < -64) || (insertion%2 === 0 && maze.shift > 64)) {
                maze.shift = 0;
                return;
            }

            // Slide the images
            if (insertion%2 === 1) maze.shift -= 1;
            else if (insertion%2 === 0) maze.shift += 1;

            // Request another frame
            requestAnimationFrame(function(){ return maze.animate(insertion, number); });
        },
        getSprite: function(tile) {
            // L sprites
            if (tile[0] === 1 && tile[1] === 1 && tile[2] === 0 && tile[3] === 0) return maze.sprites[0][0];
            else if (tile[0] === 0 && tile[1] === 1 && tile[2] === 1 && tile[3] === 0) return maze.sprites[0][1];
            else if (tile[0] === 0 && tile[1] === 0 && tile[2] === 1 && tile[3] === 1) return maze.sprites[0][2];
            else if (tile[0] === 1 && tile[1] === 0 && tile[2] === 0 && tile[3] === 1) return maze.sprites[0][3];            
            
            // I sprites
            if (tile[0] === 0 && tile[1] === 1 && tile[2] === 0 && tile[3] === 1) return maze.sprites[1][0];
            else if (tile[0] === 1 && tile[1] === 0 && tile[2] === 1 && tile[3] === 0) return maze.sprites[1][1];

            // T sprites
            if (tile[0] === 0 && tile[1] === 0 && tile[2] === 1 && tile[3] === 0) return maze.sprites[2][0];
            else if (tile[0] === 0 && tile[1] === 0 && tile[2] === 0 && tile[3] === 1) return maze.sprites[2][1];
            else if (tile[0] === 1 && tile[1] === 0 && tile[2] === 0 && tile[3] === 0) return maze.sprites[2][2];
            else if (tile[0] === 0 && tile[1] === 1 && tile[2] === 0 && tile[3] === 0) return maze.sprites[2][3];
        }
    };

    // Create the rotated variants of the given image
    function createVariants(image) {
        let variants = [];
        for (let i = 1; i < 4; i++) {
            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d");
            canvas.width = 64;
            canvas.height = 64;
            ctx.translate(32, 32);
            ctx.rotate((Math.PI/2)*i);
            ctx.drawImage(image, -32, -32, 64, 64);
            variants.push(canvas);
        }
        return variants;
    }

    function loadImages () {
        let counter = 0;
        return new Promise((resolve, reject) => {
            for (let i in images) {
                let image = new Image();
                image.onload = function() {
                    if (!maze.sprites[i]) maze.sprites[i] = [];
                    
                    maze.sprites[i][0] = image;
                    maze.sprites[i].push(...createVariants(image));

                    // When all images are loaded, resolve promise
                    if (++counter === images.length) resolve();
                };
                image.crossOrigin="anonymous"
                image.src = images[i];
            }
        });
    }

    let canvas = document.getElementById("maze");
    let ctx = canvas.getContext("2d");
    
    canvas.width = (maze.dimensions.x+2)*64;
    canvas.height = (maze.dimensions.y+2)*64;

    let images = ["https://raw.githubusercontent.com/cwkhawand/labyrinth-web/main/images/L.png",
                  "https://raw.githubusercontent.com/cwkhawand/labyrinth-web/main/images/I.png",
                  "https://raw.githubusercontent.com/cwkhawand/labyrinth-web/main/images/T.png"];



    maze.labyrinth = [
        [[0, 0, 0, 1, 0], [0, 0, 0, 1, 0], [1, 0, 1, 0, 0]],
        [[1, 0, 1, 0, 0], [0, 1, 0, 1, 0], [0, 1, 0, 1, 0]],
        [[0, 1, 1, 0, 0], [0, 0, 1, 1, 0], [0, 1, 0, 1, 0]]
    ];

    loadImages().then(() => {
        maze.draw();
    });
</script>